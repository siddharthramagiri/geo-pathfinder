<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pathfinding Finder - Graph Data-Structure</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: system-ui, -apple-system, sans-serif;
        }

        #app {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        #sidebar {
            width: 320px;
            height: 100vh;
            overflow-y: auto;
            flex-shrink: 0;
            transition: margin-left 0.3s ease;
        }

        #sidebar.collapsed {
            margin-left: -320px;
        }

        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        #controls {
            flex-shrink: 0;
        }

        #mapContainer {
            flex: 1;
            position: relative;
            min-height: 0;
        }

        #map {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .leaflet-container {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #statsBar {
            flex-shrink: 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div id="app">
    <!-- Sidebar -->
    <div id="sidebar" class="bg-white shadow-lg">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-blue-600">Path Finder</h1>
                    <p class="text-sm text-gray-600">Visualize the Shortest-Route using Graph Data Structure</p>
                    <br/>
                    <p class="text-sm text-gray-400"> ⚠️ Select only inside the Telangana Region, Developed with limited area for the Memory Efficiency </p>
                </div>
            </div>

            <div class="space-y-6">
                <div>
                    <h3 class="font-semibold mb-2 text-gray-800">Algorithms</h3>
                    <ul class="text-sm text-gray-600 space-y-1">
                        <li>• A* Algorithm</li>
                        <li>• Dijkstra's Algorithm</li>
                        <li>• Best First Search</li>
                    </ul>
                </div>

                <div>
                    <h3 class="font-semibold mb-2 text-gray-800">How to Use</h3>
                    <ol class="text-sm text-gray-600 space-y-1">
                        <li>1. Click map to set start point</li>
                        <li>2. Click within radius for end point</li>
                        <li>3. Select algorithm</li>
                        <li>4. Click "Visualize"</li>
                    </ol>
                </div>

                <div>
                    <h3 class="font-semibold mb-2 text-gray-800">Settings</h3>
                    <div class="space-y-3">
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" id="showExploration" checked class="rounded">
                            <span>Show Exploration</span>
                        </label>
                        <div>
                            <label class="text-sm block mb-1">Speed (ms)</label>
                            <input type="range" id="animSpeed" min="10" max="200" value="50" class="w-full">
                            <span id="speedValue" class="text-xs text-gray-500">50ms</span>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="font-semibold mb-2 text-gray-800">About</h3>
                    <p class="text-sm text-gray-600">
                        Visual learning tool for understanding pathfinding algorithms in real-world navigation.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main">
        <!-- Top Controls -->
        <div id="controls" class="bg-white shadow-md p-4 flex items-center gap-4 flex-wrap">
            <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>

            <input
                    type="text"
                    id="searchInput"
                    placeholder="Search location..."
                    class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 flex-1 max-w-xs"
            >
            <button onclick="searchLocation()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Search
            </button>

            <select id="algorithm" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="astar">A* Algorithm</option>
                <option value="dijkstra">Dijkstra</option>
                <option value="best">Best First</option>
            </select>

            <button onclick="clearMap()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                Clear
            </button>

            <button onclick="visualize()" id="visualizeBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                Visualize
            </button>
        </div>

        <!-- Map Container -->
        <div id="mapContainer">
            <div id="map"></div>
        </div>

        <!-- Stats Bar -->
        <div id="statsBar" class="bg-gray-800 text-white p-4 hidden">
            <div class="flex justify-around text-sm">
                <div><span class="font-semibold">Distance:</span> <span id="distance">0</span> km</div>
                <div><span class="font-semibold">Explored:</span> <span id="explored">0</span></div>
                <div><span class="font-semibold">Path Nodes:</span> <span id="pathNodes">0</span></div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 z-[2000] hidden items-center justify-center">
            <div class="bg-white p-6 rounded-lg shadow-xl">
                <div class="spinner mx-auto"></div>
                <p class="mt-4 text-center">Calculating path...</p>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:8080/api';
    const RADAR_RADIUS = 1000;

    let map;
    let startMarker = null;
    let endMarker = null;
    let radarCircle = null;
    let explorationLayer = null;
    let finalPathLayer = null;

    function initMap() {
        console.log('Initializing map...');

        // Initialize map with Mumbai coordinates
        map = L.map('map', {
            center: [17.3850, 78.4867],
            zoom: 13,
            zoomControl: true
        });

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        console.log('Map initialized successfully');

        // Handle map clicks
        map.on('click', handleMapClick);

        // Force map to resize
        setTimeout(() => {
            map.invalidateSize();
        }, 100);
    }

    function handleMapClick(e) {
        console.log('Map clicked at:', e.latlng);

        if (!startMarker) {
            // Set start point
            startMarker = L.marker(e.latlng).addTo(map)
                .bindPopup('Start Point').openPopup();

            // Show radar circle
            radarCircle = L.circle(e.latlng, {
                radius: RADAR_RADIUS,
                color: '#3388ff',
                fillColor: '#3388ff',
                fillOpacity: 0.2,
                dashArray: '5,5'
            }).addTo(map);

            console.log('Start point set');

        } else if (!endMarker) {
            // Check if within radius
            const distance = startMarker.getLatLng().distanceTo(e.latlng);

            if (distance <= RADAR_RADIUS) {
                endMarker = L.marker(e.latlng).addTo(map)
                    .bindPopup('End Point').openPopup();
                map.removeLayer(radarCircle);
                radarCircle = null;
                console.log('End point set');
            } else {
                alert('Please select an end point within the 1 km radius (blue circle).');
            }
        }
    }

    function clearMap() {
        if (startMarker) map.removeLayer(startMarker);
        if (endMarker) map.removeLayer(endMarker);
        if (radarCircle) map.removeLayer(radarCircle);
        if (explorationLayer) map.removeLayer(explorationLayer);
        if (finalPathLayer) map.removeLayer(finalPathLayer);

        startMarker = null;
        endMarker = null;
        radarCircle = null;
        explorationLayer = null;
        finalPathLayer = null;

        document.getElementById('statsBar').classList.add('hidden');
        console.log('Map cleared');
    }

    async function visualize() {
        if (!startMarker || !endMarker) {
            alert('Please select both start and end points on the map');
            return;
        }

        const loading = document.getElementById('loading');
        loading.classList.remove('hidden');
        loading.classList.add('flex');

        if (explorationLayer) map.removeLayer(explorationLayer);
        if (finalPathLayer) map.removeLayer(finalPathLayer);

        const algorithm = document.getElementById('algorithm').value;
        const showExploration = document.getElementById('showExploration').checked;
        const animSpeed = parseInt(document.getElementById('animSpeed').value);

        try {
            const response = await fetch(`${API_BASE_URL}/pathfinding/calculate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    startLat: startMarker.getLatLng().lat,
                    startLon: startMarker.getLatLng().lng,
                    endLat: endMarker.getLatLng().lat,
                    endLon: endMarker.getLatLng().lng,
                    algorithm: algorithm
                })
            });

            if (!response.ok) throw new Error('Failed to calculate path');

            const data = await response.json();
            console.log('Path data received:', data);

            if (showExploration && data.exploration && data.exploration.length > 0) {
                await animateExploration(data.exploration, animSpeed);
            }

            if (data.finalPath && data.finalPath.length > 0) {
                drawFinalPath(data.finalPath);
            }

            displayStats(data);

        } catch (error) {
            console.error('Error:', error);
            alert('Error: Make sure the Java backend is running on http://localhost:8080\n\nTo start backend:\ncd backend\nmvn spring-boot:run');
        } finally {
            loading.classList.add('hidden');
            loading.classList.remove('flex');
        }
    }

    function animateExploration(exploration, speed) {
        return new Promise((resolve) => {
            explorationLayer = L.layerGroup().addTo(map);
            let index = 0;

            const interval = setInterval(() => {
                if (index < exploration.length) {
                    const coord = exploration[index];
                    L.circleMarker([coord[0], coord[1]], {
                        color: 'blue',
                        radius: 3,
                        fillOpacity: 0.5
                    }).addTo(explorationLayer);
                    index++;
                } else {
                    clearInterval(interval);
                    resolve();
                }
            }, speed);
        });
    }

    function drawFinalPath(path) {
        finalPathLayer = L.polyline(path, {
            color: 'red',
            weight: 5,
            opacity: 0.8
        }).addTo(map);

        map.fitBounds(finalPathLayer.getBounds(), { padding: [50, 50] });
    }

    function displayStats(data) {
        document.getElementById('distance').textContent = (data.distance / 1000).toFixed(2);
        document.getElementById('explored').textContent = data.numExplored;
        document.getElementById('pathNodes').textContent = data.numFinalPath;
        document.getElementById('statsBar').classList.remove('hidden');
    }

    async function searchLocation() {
        const query = document.getElementById('searchInput').value;
        if (!query.trim()) return;

        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`
            );
            const data = await response.json();

            if (data && data.length > 0) {
                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);
                map.setView([lat, lon], 13);
                console.log('Location found:', query);
            } else {
                alert('Location not found');
            }
        } catch (error) {
            console.error('Search error:', error);
            alert('Error searching location');
        }
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('collapsed');
        setTimeout(() => map.invalidateSize(), 300);
    }

    document.getElementById('animSpeed').addEventListener('input', (e) => {
        document.getElementById('speedValue').textContent = e.target.value + 'ms';
    });

    document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchLocation();
    });

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMap);
    } else {
        initMap();
    }
</script>
</body>
</html>